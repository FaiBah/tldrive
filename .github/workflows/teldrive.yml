name: Run Teldrive with Playit Tunnel

on:
  workflow_dispatch:

jobs:
  run-teldrive:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and extract Teldrive
        run: |
          wget -q https://github.com/tgdrive/teldrive/releases/download/1.7.0/teldrive-1.7.0-linux-amd64.tar.gz
          tar -xzf teldrive-1.7.0-linux-amd64.tar.gz
          ls -l
          # Find the extracted binary and rename it to teldrive
          FILE=$(find . -type f -name "teldrive*" | head -n 1)
          chmod +x "$FILE"
          mv "$FILE" teldrive
          ./teldrive --version

      - name: Run Teldrive server
        run: |
          nohup ./teldrive serve > server.log 2>&1 &
          sleep 5
          echo "âœ… Teldrive server started."

      - name: Download Playit client
        run: |
          wget -q https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64
          mv playit-linux-amd64 playit
          chmod +x playit

      - name: Connect Playit tunnel
        env:
          PLAYIT_AUTH: ${{ secrets.PLAYIT_AUTH }}
        run: |
          echo "ðŸ”— Connecting Playit tunnel..."
          nohup ./playit --secret "$PLAYIT_AUTH" > playit.log 2>&1 &
          sleep 10
          echo "âœ… Playit tunnel started successfully."
          echo "--- PLAYIT LOG START ---"
          tail -n 20 playit.log
          echo "--- PLAYIT LOG END ---"

      - name: Keep alive
        run: |
          echo "ðŸŸ¢ Workflow is now running (Teldrive + Playit)."
          tail -f /dev/null
